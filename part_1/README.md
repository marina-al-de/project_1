# Решение задачи 1.1

## Перечень технологий
Технологии использованные при решении задачи:
- Реляционная СУБД: PostgreSQL 17;
- Среда SQL разработки : pgAdmin; 
- ETL c помощью Python 3.12, дополнительные библиотеки: pandas, psycopg2, psycopg2.extras

## Подготовка базы данных

- **Схема DS с таблицами под загрузку данных**

В БД создаём схему DS с таблицами под загрузку данных из csv-файлов. 

Скрипт для создания таблиц:

`part_1/01_db_setup/схема DS  и таблицы.sql`


- **Схема LOGS и таблица для логов**

Создаём схему  LOGS и таблицу `logs.uploads_in_ds`. Согласно условию задания в таблицу добавлены столбцы `load_start_tstamp` и `load_end_tstamp` для логирования начала и окончание работы процесса загрузки данных.
Кроме этого, добавила поля `destination_table` (таблица, куда осущетвляется загрузка данных), `user_name` (пользователь, выполняющий загрузку), `pk_date` и `pk_second_part` (поскольку во всех таблицах РК составной, 
в таблице для логов также добавлены 2 столбца, чтобы отражать РК загружаемых строк), `operation` (insert or update). 

ПРИМЕЧАНИЯ: в дальнейших задачах будут внесены изменения в таблицу `logs.uploads_in_ds`. Здесь оставлен первоначальный вариант.

Скрипт для таблицы:

`part_1/01_db_setup/схема logs таблица логов.sql`


- **Триггерная функция и триггер на заполнение логов**

Последний шаг - создание триггерной функции и триггера на заполнение таблицы `logs.uploads_in_ds` при загрузке данных в целевый таблицы. Согласно условию задачи по логам должно быть видно дату и время старта и окончания загрузки.
Поэтому сделала две разные функции: первая `ds.update_logs_start()` логирует начало загрузки, и заполняет все сотлбцы таблицы `logs.uploads_in_ds` соотвествующими данными, кроме `load_end_tstamp`; вторая функция `ds.update_logs_end() `
добавляет только время окончания загрузки.

В соотвествии с функциями создала тригеры `upload_start_table_name` и `upload_end_table_name`. `upload_start_table_name` использует функцию `ds.update_logs_start()` и запускается ДО начала загрузки данных; `upload_end_table_name` использует
`ds.update_logs_end()`и запускается ПОСЛЕ окончания загрузки.

ПРИМЕЧАНИЯ: в дальнейших задачах будут внесены изменения в функции `ds.update_logs_start()` и `ds.update_logs_end()` . Здесь оставлен первоначальный вариант.

Скрипт для функций и триггеров:

`part_1/01_db_setup/фнукции и тригеры для заполнение логов.sql`

## Обработка данных из csv-файлов и загрузка в БД

- **Подготовка данных из csv-файлов**

С помощью pandas преобразуем данные из csv-файлов в dataframe, которые затем будем использовать при загрузке в БД. В каждом df меняем формат данных, в df `md_currency_d_df` потребовалось сделать дополнительные преобразования.
Все df добавлены в список, который будет использован в главном модуле, который осуществляет загрузку в БД.

Скрипт для созания df:

`part_1/02_etl/csv_to_df.py`


- **SQL-cкрипты для курсоров**

Для каждой целевой таблицы в БД, кроме `ds.ft_posting_f` составляем SQL-statement для загрузки данных в режиме «Запись или замена». Согласно условию задачи у таблицы ft_posting_f нет первичного ключа. 
Можно считать, что мы всегда в нее будем загружать полный набор данных, передкаждой загрузкой ее необходимо очищать. Поэтому для неё простой insert statement. Для остальных таблиц используем `merge`.
Все SQL-statement добавлены в список, который будет использован в главном модуле, который осуществляет загрузку в БД.

SQL-cкрипты:

`part_1/02_etl/upserts.py`


- **Загрузка данных в БД**

С помощью psycopg2 подключаемся к БД и  осздаём курсор для работы с БД. Посредством метода psycopg2.extras.execute_batch() осуществляется загрузка в БД. Помимо курсора, передаём в данный метод SQL-statement и dataframe, преобразованный в data_tuples.

Скрипт:

`part_1/02_etl/etl_main.py`

## Демонстрация работы потока

В папке `part_1/03_demo` собраны файлы, используемые для демонстрации работы потока на примере `ds.ft_balance_f`. Они аналогичны скриптам из `part_1/02_etl`, но для демонстрации осавила только код, необходимый для заполения таблицы `ds.ft_balance_f`.

Ссылка на видео с демонстрацией работы в файле:

`part_1/03_demo/video_link.txt`











