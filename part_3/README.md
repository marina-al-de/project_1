# Решение задачи 1.2

## Перечень технологий
Технологии использованные при решении задачи:
- Реляционная СУБД: PostgreSQL 17;
- Среда SQL разработки : pgAdmin;

## Подготовка слоя DM в базе данных

- **Витрина для формы 101**

В БД создаём витрину для формы 101 `dm.dm_f101_round_f`.

Скрипт для создания таблицы:

`part_3/01 create table dm.dm_f101_round_f.sql`

- **Логирование**

Для логирования изменений в таблице `dm.dm_f101_round_f` воспользуемся ранее созданной таблицей для логов `logs.logs_for_ds_dm` и триггерными функциями `ds.update_logs_start()` и `ds.update_logs_end()`.
Добавим триггеры для `dm.dm_f101_round_f`.

Скрипт для триггеров:

`part_3/02 trigger for logs.sql`

## Заполнение формы 101

Создаём процедуру `dm.fill_f101_round_f` для заполнения витрины `dm.dm_f101_round_f`. 

Сначала объявляем переменные`p_from_date`, `p_to_date` и `previous_period_end_date` и присваиваем им значения первого дня отчетного периода, последнего дня отчетного периода и дня, предшествующему первому дню отчетного периода, соотвественно. 

Затем удаляем записи за дату расчета. 

Далее в СТЕ `turn_deb_cre` извлекаем из витрины `dm.dm_account_turnover_f` суммы дебитовых и кредитовых обротов в рублях для рублёвых и не рублёвых счетов и группируем по балансовым счетам второго порядка. В задании было указано, что для данного расчёта можно использовать поле `DS.MD_ACCOUNT_D.currency_code` (где коды валюты 810 или 643 соответсвуют рублёвым счетам), но в итоговом варианте реализовала другую логику. Т.к. в витрине `dm.dm_account_turnover_f` уже расчитаны значения обротов в оригинальной валюте и в рублях, использовала условие `act.credit_amount_rub = act.credit_amount` и `act.credit_amount_rub != act.credit_amount`, чтобы определить является ли счёт рублёвым или валютным. 

Во втором СТЕ `bal_in_out` извлекаем из витрины `dm.dm_account_balance_f` суммы остатков за первый и последний день расчётного периода в рублях для рублёвых и не рублёвых счетов и группируем по балансовым счетам второго порядка. Чтобы определить является ли счёт валютным или рублёвым, реализовала ту же логику, что и в передыдущем СТЕ. 

На последнем этапе объединяем остатки и обороты по счетам со справочной информацией из ds.md_ledger_account_s и загружаем полученные данные в витрину dm.dm_f101_round_f.

Скрипт процедуры:

`part_3/03 procedure dm.fill_f101_round_f.sql`

## Демонстрация

Ссылка на видео с демонстрацией работы в файле:

`part_3/video_link.txt`
